= Design Patterns - TD2
J.-M. Bruel <jbruel@gmail.com>
v20.1 {localdate}
:tdnum: TD2
:uk:
:imagesdir: images
//------------------------- variables de configuration
// only used when master document
:icons: font
:experimental:
:numbered!:
:status:
:baseURL: https://github.com/LP-APSIO/MobileModeling2020
:github: https://github.com[GitHub]
// Specific to GitHub
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:

endif::[]
//------------------------------------ 
ifdef::uk[]
:lang: uk
:lastName: LAST NAME
:firstName: First Name
:group: Group
:example: Example
:Enseignants: Teachers
:principe: Good design principle
:assignment: Assignment info
:requirements: Requirements
:initial: Initial tasks
:allerPlusLoin: Still hungry?...
:about: About...
:contrib: Contributors
endif::[]
ifndef::uk[]
:lang: fr
:lastName: NOM
:firstName: Prénom
:group: Groupe
:example: Exemple
:Enseignants: Enseignants
:principe: Principe Objet
:assignment: Informations générales
:requirements: Pré-requis
:initial: Tâche initiale
:allerPlusLoin: Pour Aller plus loin...
:about: À propos...
:contrib: Contributeurs
endif::[]
:java: https://www.java.com/fr/[Java]
//------------------------------------ 

ifdef::uk[]
== {tdnum} initial code
This is a template for the students' assignments.

ifndef::backend-pdf[]
TIP: Course material: pass:[<i class="fa fa-mobile"></i> <i class="fa fa-tablet"></i> <i class="fa fa-laptop"></i>] http://bit.ly/jmb-cpoa
endif::[]

ifdef::backend-pdf[]
TIP: Course material: icon:mobile[] icon:tablet[] icon:laptop[] http://bit.ly/jmb-cpoa
endif::[]
endif::[]

ifndef::uk[]
== Code initial pour le {tdnum}

ifndef::backend-pdf[]
TIP: Rappel du cours : pass:[<i class="fa fa-mobile"></i> <i class="fa fa-tablet"></i> <i class="fa fa-laptop"></i>] http://bit.ly/jmb-cpoa
endif::[]

ifdef::backend-pdf[]
TIP: Rappel du cours : icon:mobile[] icon:tablet[] icon:laptop[] http://bit.ly/jmb-cpoa
endif::[]

endif::[]

//------------------------------------ 
== {assignment}

{lastName}:: BRUEL

{firstName}:: Jean-Michel

{group} #::

[%interactive]
- [x] {Enseignants}
- [ ] 1
- [ ] 2
- [ ] 3
- [ ] 4
- [ ] Innopolis

//------------------------------------ 
== {requirements}

ifdef::uk[]
You'll need:

[%interactive]
* [x] A {Github} account  
* [ ] A https://gitforwindows.org/[Git Bash] terminal (if you use Window$)
endif::[]
ifndef::uk[]
Il vous faut :

[%interactive]
* [x] Un compte {Github}  
* [ ] Un terminal de type https://gitforwindows.org/[Git Bash]  (si vous utilisez Window$)
endif::[]

ifdef::uk[]
[TIP]
====    
Try the following command in your terminal to check your `git` environment:
endif::[]
ifndef::uk[]
[TIP]
====    
Essayez la commande suivante dans votre terminal pour vérifier votre environnement `git` :
endif::[]

[source,shell]
....
git config --global -l
....
====

//------------------------------------ 
== {initial}

ifdef::uk[]
[%interactive]
* [x] Click on the Github Classroom link provided by your teacher (in fact, this should be done if you read this).
* [ ] Clone on your machine the Github project generated by Github Classroom.  
* [ ] Modify the README file to add your last name, first name and group number. 
* [ ] Commit and push using the following message:
endif::[]
ifndef::uk[]
[%interactive]
* [x] Clickez sur le lien Github Classroom fourni par votre enseignant (en fait c'est déjà fait si vous lisez ces lignes).
* [ ] Clonez sur votre machine le projet Github généré pour vous par Github Classroom.  
* [ ] Modifez le `README` pour modifier Nom, Prénom et Groupe. 
* [ ] Commit & push:
endif::[]

ifndef::backend-pdf[.pass:[<i class="fa fa-github"></i>] commit/push]
ifdef::backend-pdf[.icon:github[] commit/push]
[source,shell]
....
fix #0 Initial task done
....

[IMPORTANT]
ifndef::uk[]
Dans la suite de ce document, à chaque fois que vous trouverez un énoncé commençant par `fix #...` vous devez vérifier que vos scripts/fichiers modifiés sont bien dans votre dépôt local en vue de committer et de pusher les modifications sur votre dépôt distant en utilisant comme message de commit cet énoncé.

[TIP]
====
- Si vous voulez vérifier que vous êtes prêt pour le `fix #0`, utilisez la commande : `make check`.
- Si vous voulez avoir la liste des ToDos de ce TP/TP, exécutez `make todos`.
====
endif::[]
ifdef::uk[]
In the following, every time you'll see à `fix #...` text, 
make sure all your files are committed, and then push your modifications in the distant repo, making sure you used the corresponding message (`fix #...`) in one of the `commit` messages.

[TIP]
====
- If you want to check that you're really ready for `fix #0`, you can run the command in your shell: `make check`.
- If you want to list the ToDos of the day, run `make todos`.
====
endif::[]

//------------------------------------ 
//------------------------------------ 
//------------------------------------ 
//------------  Let's START----------- 
//------------------------------------ 
//------------------------------------ 


:numbered:
//------------------------------------ 
== The "Chocolate Factory" app

[NOTE]
=====
This TD exercise is inspired from the excellent https://www.oreilly.com/library/view/head-first-design/0596007124/[book]: "Head First: Design Pattern.
Bert Bates, Eric Freeman, Elisabeth Freeman, Kathy Sierra. Editions O'Reilly. 2005."

image::headFirst.jpg[link="https://www.oreilly.com/library/view/head-first-design/0596007124/",width=40%]
=====

=== Existing application

You're a developer in a chocolate factory simulator company.
Chocolate factories use boilers supervised by controllers. 

The job of the boiler is to take in chocolate and milk, bring them to a boil, and then pass them on to the next phase of making chocolate bars.

Here is the controller class you have developed:

.The `ChocolateBoiler` class
[source,java]
------
	public class ChocolateBoiler {
		private boolean empty;
		private boolean boiled;

		public ChocolateBoiler() {
			empty = true;
			boiled = false;
		}

		public void fill() {
			if (isEmpty()) {
				empty = false;
				boiled = false;
				// fill the boiler actions
			}
		}

		public void drain() {
			if (!isEmpty() && isBoiled()) {
				// drain the boiler 
				empty = true;
			}
		}

		public void boil() {
			if (!isEmpty() && !isBoiled()) {
				// boil the content
				boiled = true;
			}
		}

		public boolean isEmpty() { return empty;}

		public boolean isBoiled() { return boiled;}
	}
------

//----------------------------- Question ------------------
.*QUESTION*
[WARNING]
====
. What are the attributes `empty` and `boiled` used for?
====

You're making horrible nightmares (really?) that you drain in a ocean of chocolate.

//----------------------------- Question ------------------
.*QUESTION*
[WARNING]
====
. What could be wrong if two different objects manipulate the same physical boiler?
+
To test this scenario, execute the JUnit test `twoChocolateBoilersMightBlowTheFactory`.
. What should we guaranty to avoid this problem?
. Find examples where it is important to make sure there is only one instance of certain classes.
====

ifndef::backend-pdf[.pass:[<i class="fa fa-github"></i>] commit/push]
ifdef::backend-pdf[.icon:github[] commit/push]
[source,shell]
....
fix #1.1 Initial code
....


=== Solution 1

You remember your first coding experience in {java} about class variables  you propose to use an instance counter to solve the problem.

//----------------------------- Question ------------------
.*QUESTION*
[WARNING]
====
You first modify the constructor so that it only works when the instance counter is equal to 0.
What is wrong in the following excerpt:

.ChocolateBoilerCpt.java
[source,java]
-----
public class ChocolateBoilerCpt { 
	private boolean empty;
	private boolean boiled; 
	private static int nbInstance = 0;

	public ChocolateBoilerCpt() {
		empty = true;
		boiled = false;
		if (nbInstance == 0) {
			nbInstance = 1;
			return this;
		}
		else {
			return null;
		}
...
-----
====

=== Solution 2

You change your strategy and remember seeing this kind of code:

.An idea!
[source,java]
------
public class MyClasse {
	private MyClasse() {...}
}
------

//----------------------------- Question ------------------
.*QUESTION*
[WARNING]
====
. Is it allowed to have a private constructor?
. How can we create an instance under those circumstances? 
Don't we end-up simply with an unusable class?
====

//----------------------------------------------------- Correction -------------------------
ifdef::prof[]
[CAUTION]
====
. Yes!
. By implementing a dedicated method ;-).
====
endif::prof[]
//----------------------------------------------------- fin Correction -------------------------


//----------------------------- Question ------------------
.*TODO*:
[WARNING]
====
[%interactive]
* [ ] Complete the following code to solve the problem:
+
.ChocolateBoilerSafe
[source,java]
-----
public class ChocolateBoilerSafe {
	private boolean empty;
	private boolean boiled;
	...
	...

	        ChocolateBoiler() {
		...
		...
		}

	...
	...
	...
	...

	public void fill() {
		if (isEmpty()) {
			empty = false;
			boiled = false;
			// ... }
		}
		// ...
}
-----
+
* [ ] Write a test that use this class
* [ ] Commit&Push when everything is ready
+
ifndef::backend-pdf[.pass:[<i class="fa fa-github"></i>] commit/push]
ifdef::backend-pdf[.icon:github[] commit/push]
[source,shell]
....
fix #1.3 Solution with a private constructor
....
====

=== It's not over!

It looks like the Chocolate Boiler still has a problem: the `ChocolateBoiler`'s `fill()` method was able to start filling the boiler even though a batch of milk and chocolate was already boiling! 
What happened!?

//----------------------------- Question ------------------
.*QUESTION*
[WARNING]
====
. We have two threads, each executing this code. 
Your job is to play the JVM and determine whether there is a case in which two threads might get ahold of different boiler objects. 
Use the code magnets to help you study how the code might interleave to create two boiler objects:
+
[cols="3"]
|===
|*Thread 1*
|*Thread 2*
|*Valeur de `uniqueInstance`*
|||
|||
|||
|||
|||
|||
|||
|||
|||
|||
|||
|||
|||
|||
|||
|||
|===
====

.Bloc 1
[source,java]
------
public static ChocolateBoilerSafe getInstance() {
------

.Bloc 2
[source,java]
------
if (uniqueInstance == null) {
------

.Bloc 3
[source,java]
------
uniqueInstance = new ChocolateBoilerSafe();
------

.Bloc 4
[source,java]
------
		}
------

.Bloc 5
[source,java]
------
		return uniqueInstance;
------

.Bloc 6
[source,java]
------
	}
------

//----------------------------------------------------- Correction -------------------------
ifdef::prof[]
[CAUTION]
====
.Solution (source <<Freeman05>>)
image::thread-sol.png[]

[source,java,linenums]
------
public class ChocolateBoilerSafe {
	private boolean empty;
	private boolean boiled;
	private static ChocolateBoilerSafe uniqueInstance;

	private ChocolateBoilerSafe() {
	  empty = true;
	  boiled = false;
	}

	public static final ChocolateBoilerSafe getInstance() {
	  if (uniqueInstance == null) {
        uniqueInstance = new ChocolateBoilerSafe();
	  }
	  return uniqueInstance;
	}
------

Explications :

. Thread 1 appelle `getInstance()` et détermine que `uniqueInstance` est `null` en ligne 12
. Thread 1 entre dans le bloc `if` puis est préempté par le thread 2 avant
l'exécution de la ligne 13
. Thread 2 appelle `getInstance()` et détermine que `uniqueInstance` est `null` en ligne  12
. Thread 2 entre dans le bloc `if`, crée un nouveau `ChocolateBoilerSafe` et
assigne ce nouvel objet à la variable `uniqueInstance` en ligne  13
. Thread 2 retourne la référence au `ChocolateBoilerSafe` en ligne  15
. Thread 2 est préempté par le Thread 1
. Thread 1 reprend où il s'était arrêté et exécute la ligne 13 créant alors une autre instance de `ChocolateBoilerSafe`
. Thread 1 retourne cette nouvelle instance en ligne  15

====

endif::prof[]
//----------------------------------------------------- fin Correction -------------------------

=== Solution to the multithreading

//----------------------------- Question ------------------
.*QUESTION*
[WARNING]
====
. Propose a simple solution to this problem.
====
//----------------------------------------------------- Correction -------------------------
ifdef::prof[]
[CAUTION]
=====
Il suffit de faire de `getInstance()` une méthode *synchronisée* :
[source,java]
------
public class ChocolateBoilerSafe {
  private boolean empty;
  private boolean boiled;
  private static ChocolateBoilerSafe uniqueInstance;

  private ChocolateBoilerSafe() {
    empty = true;
    boiled = false;
  }

  public static synchronized ChocolateBoilerSafe getInstance() {
    if (uniqueInstance == null) {
      uniqueInstance = new ChocolateBoilerSafe();
    }
    return uniqueInstance;
  }
------
=====
endif::prof[]
//----------------------------------------------------- fin Correction -------------------------

=== Problem of the solution!!

//----------------------------- Question ------------------
.*QUESTION*
[WARNING]
====
. How many times this mechanism is used?
. Hence, what do you think of this solution?
. Propose a solution where the instance is created at the "beginning" rather than on demand.
====
//----------------------------------------------------- Correction -------------------------
ifdef::prof[]
[CAUTION]
=====
. Une seule fois, lors du 1er passage dans la méthode!!
. C'est bien trop consomateur en ressource! En pratique, il y a des copies de blocs de mémoire, ce qui prend du temps.

. Voici un exemple :
+
.Création de l'instance unique au démarrage
[source,java]
------
public class Singleton {
	private static final Singleton uniqueInstance = new Singleton();
	private Singleton() {}
	public static Singleton getInstance() { return uniqueInstance;}
}
------
+
En adoptant cette approche, nous nous reposons sur la JVM pour créer l'unique instance du Singleton quand la classe est chargée.
La JVM garantit que l'instance sera créée avant qu'un thread quelconque n'accède à la variable statique `uniqueInstance`.

=====
endif::prof[]
//----------------------------------------------------- fin Correction -------------------------

[[Singleton]]
== Singleton

Congratulations, you manipulated your 2nd pattern: *Singleton*.

[NOTE]
.Design pattern: *Singleton*
====
*Singleton* guaranties that a classe has only one instance and provides a global access to this instance.


ifndef::slides[.UML model of the _Singleton_ pattern]
image::singleton.svg[]
====

ifdef::prof[]
.Quelques exemples de description du patron Singleton
image::google-singleton.png[link="images/google-singleton.png"]
endif::prof[]

:numbered!:
[appendix]
== {allerPlusLoin}

//----------------------------- Question ------------------
.*QUESTION*
[WARNING]
====
. What is the difference between a singleton and a global variable?
. How would you test the <<Singleton,Singleton>> pattern?
====

//----------------------------- Question ------------------
.*TODO*:
[WARNING]
====
[%interactive]
* [ ] Add some tests to your repo to test the effectiveness of the pattern
* [ ] Commit&Push when everything is ready
+
ifndef::backend-pdf[.pass:[<i class="fa fa-github"></i>] commit/push]
ifdef::backend-pdf[.icon:github[] commit/push]
[source,shell]
....
fix #2 Tests
....
+
====

//----------------------------------------------------- Correction -------------------------
ifdef::prof[]
[CAUTION]
====
Quelques éléments de solution :

- En {java} les variables globales sont des références statiques à des objets.
- Problème déjà vu de l'instanciation à la demande vs. au démarrage.

Exemples de test :

- Tentative d'instanciation depuis l'extérieur de la classe
- Tentative de construction de deux objets de type Singleton

====
endif::prof[]
//----------------------------------------------------- fin Correction -------------------------




ifndef::compact[]
//------------------------------------ 
== {contrib}
//------------------------------------ 

- mailto:jbruel@gmail.com[Jean-Michel Bruel]

== {about}

****************************************************************
Baked with {asciidoctorlink} (version `{asciidoctor-version}`) from 'Dan Allen', based on {asciidoc}.
'Licence Creative Commons'.
image:88x31.png["Licence Creative
Commons",style="border-width:0",link="http://creativecommons.org/licenses/by-sa/3.0/"]
http://creativecommons.org/licenses/by-sa/3.0/[licence Creative Commons Paternité - Partage à l&#39;Identique 3.0 non transposé].
****************************************************************
endif::compact[]
